apiVersion: v1
kind: ConfigMap
metadata:
  creationTimestamp: null
  name: prometheus-core
  namespace: monitoring
data:
  prometheus.yaml: |

    global:
      scrape_interval:     15s
      evaluation_interval: 15s

    scrape_configs:

    # - job_name: 'federate'
    #   scrape_interval: 15s
    #
    #   honor_labels: true
    #   metrics_path: '/federate'

    #   params:
    #     'match[]':
    #       - '{job_name="kafka"}'
    #       - '{__name__=~"job:.*"}'

    #   static_configs:
    #     - targets: [ '' ]
    #       labels:
    #         k8s_cluster: 'centralus'
    #         kafka_cluster: 'destination'

    # # Scrape config for Kafka source
    # - job_name: 'kafka'
    #   honor_labels: true
    #   static_configs:
    #   - targets: [ 'broker.kafka.svc.cluster.local:5556' ]
    #     labels:
    #       kafka_cluster: 'source'

    # # Scrape config for Kafka source
    # - job_name: 'kafka_src'
    #   honor_labels: true
    #   static_configs:
    #   - targets: [ 'broker.kafka-source.svc.cluster.local:5556' ]
    #     labels:
    #       kafka_cluster: 'source'

    # # Scrape config for Kafka destination
    # - job_name: 'kafka_dest'
    #   honor_labels: true
    #   static_configs:
    #   - targets: [ 'broker.kafka-destination.svc.cluster.local:5556' ]
    #     labels:
    #       kafka_cluster: 'destination'


    # # Scrape config for ureplicator
    # - job_name: 'ureplicator'
    #   honor_labels: true
    #   static_configs:
    #   - targets: [ 'graphite-exporter.ureplicator.svc.cluster.local:9108' ]
    #     labels:
    #       namespace: 'ureplicator'
    #       app: 'ureplicator'

    # Scrape config for graphite-exporter
    - job_name: 'ureplicator'
      honor_labels: true
      static_configs:
      - targets: [ 'graphite-exporter.monitoring.svc.cluster.local:9108' ]
        labels:
          namespace: 'graphite-exporter'
          what: 'yes'


    # Scrape config for Prometheus itself
    - job_name: 'prometheus'
      honor_labels: true
      static_configs:
      - targets: ['localhost:9090']
        labels:
          component: 'prometheus'

    # Scrape config for Pushgateway
    - job_name: 'prometheus-pushgateway'
      honor_labels: true
      static_configs:
      - targets: ['prometheus-pushgateway.monitoring.svc.cluster.local:9091']
        labels:
          component: 'pushgateway'
          foo: 'bar'

    # Scrape config for kafka-monitor
    - job_name: 'kafka-monitor'
      honor_labels: true
      static_configs:
      - targets: [ 'graphite-exporter.kafka-monitor.svc.cluster.local:9108' ]
        labels:
          namespace: 'ureplicator'
          app: 'ureplicator'
          pod: 'ureplicator'

    # Scrape config for API servers.
    - job_name: 'kubernetes-apiservers'

      kubernetes_sd_configs:
      - role: endpoints

      # Default to scraping over https. If required, just disable this or change to
      # `http`.
      scheme: https
      tls_config:
        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        # insecure_skip_verify: true
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token

      # Keep only the default/kubernetes service endpoints for the https port. This
      # will add targets for each API server which Kubernetes adds an endpoint to
      # the default/kubernetes service.
      relabel_configs:
      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
        action: keep
        regex: default;kubernetes;https

    # Scrape config for nodes (kubelet).
    - job_name: 'kubernetes-nodes'
      scheme: https
      tls_config:
        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token

      kubernetes_sd_configs:
      - role: node

      relabel_configs:
      - action: labelmap
        regex: __meta_kubernetes_node_label_(.+)
      - target_label: __address__
        replacement: kubernetes.default.svc:443
      - source_labels: [__meta_kubernetes_node_name]
        regex: (.+)
        target_label: __metrics_path__
        replacement: /api/v1/nodes/${1}/proxy/metrics

    # Scrape config for Kubelet cAdvisor.
    - job_name: 'kubernetes-cadvisor'
      scheme: https
      tls_config:
        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token

      kubernetes_sd_configs:
      - role: node

      relabel_configs:
      - action: labelmap
        regex: __meta_kubernetes_node_label_(.+)
      - target_label: __address__
        replacement: kubernetes.default.svc:443
      - source_labels: [__meta_kubernetes_node_name]
        regex: (.+)
        target_label: __metrics_path__
        replacement: /api/v1/nodes/${1}/proxy/metrics/cadvisor

    # Scrape config for service endpoints.
    #
    # The relabeling allows the actual service scrape endpoint to be configured
    # via the following annotations:
    #
    # * `prometheus.io/scrape`: Only scrape services that have a value of `true`
    # * `prometheus.io/scheme`: If the metrics endpoint is secured then you will need
    # to set this to `https` & most likely set the `tls_config` of the scrape config.
    # * `prometheus.io/path`: If the metrics path is not `/metrics` override this.
    # * `prometheus.io/port`: If the metrics are exposed on a different port to the
    # service then set this appropriately.
    - job_name: 'kubernetes-service-endpoints'

      kubernetes_sd_configs:
      - role: endpoints

      relabel_configs:
      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]
        action: replace
        target_label: __scheme__
        regex: (https?)
      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
      - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]
        action: replace
        target_label: __address__
        regex: ([^:]+)(?::\d+)?;(\d+)
        replacement: $1:$2
      - action: labelmap
        regex: __meta_kubernetes_service_label_(.+)
      - source_labels: [__meta_kubernetes_namespace]
        action: replace
        target_label: kubernetes_namespace
      - source_labels: [__meta_kubernetes_service_name]
        action: replace
        target_label: kubernetes_name

    # Example scrape config for probing services via the Blackbox Exporter.
    #
    # The relabeling allows the actual service scrape endpoint to be configured
    # via the following annotations:
    #
    # * `prometheus.io/probe`: Only probe services that have a value of `true`
    # - job_name: 'kubernetes-services'
    #
    #   metrics_path: /probe
    #   params:
    #     module: [http_2xx]
    #
    #   kubernetes_sd_configs:
    #   - role: service
    #
    #   relabel_configs:
    #   - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_probe]
    #     action: keep
    #     regex: true
    #   - source_labels: [__address__]
    #     target_label: __param_target
    #   - target_label: __address__
    #     replacement: blackbox-exporter.example.com:9115
    #   - source_labels: [__param_target]
    #     target_label: instance
    #   - action: labelmap
    #     regex: __meta_kubernetes_service_label_(.+)
    #   - source_labels: [__meta_kubernetes_namespace]
    #     target_label: kubernetes_namespace
    #   - source_labels: [__meta_kubernetes_service_name]
    #     target_label: kubernetes_name

    # Example scrape config for probing ingresses via the Blackbox Exporter.
    #
    # The relabeling allows the actual ingress scrape endpoint to be configured
    # via the following annotations:
    #
    # * `prometheus.io/probe`: Only probe services that have a value of `true`
    # - job_name: 'kubernetes-ingresses'
    #
    #   metrics_path: /probe
    #   params:
    #     module: [http_2xx]
    #
    #   kubernetes_sd_configs:
    #   - role: ingress
    #
    #   relabel_configs:
    #   - source_labels: [__meta_kubernetes_ingress_annotation_prometheus_io_probe]
    #     action: keep
    #     regex: true
    #   - source_labels: [__meta_kubernetes_ingress_scheme,__address__,__meta_kubernetes_ingress_path]
    #     regex: (.+);(.+);(.+)
    #     replacement: ${1}://${2}${3}
    #     target_label: __param_target
    #   - target_label: __address__
    #     replacement: blackbox-exporter.example.com:9115
    #   - source_labels: [__param_target]
    #     target_label: instance
    #   - action: labelmap
    #     regex: __meta_kubernetes_ingress_label_(.+)
    #   - source_labels: [__meta_kubernetes_namespace]
    #     target_label: kubernetes_namespace
    #   - source_labels: [__meta_kubernetes_ingress_name]
    #     target_label: kubernetes_name

    # Example scrape config for pods
    #
    # The relabeling allows the actual pod scrape endpoint to be configured via the
    # following annotations:
    #
    # * `prometheus.io/scrape`: Only scrape pods that have a value of `true`
    # * `prometheus.io/path`: If the metrics path is not `/metrics` override this.
    # * `prometheus.io/port`: Scrape the pod on the indicated port instead of the
    # pod's declared ports (default is a port-free target if none are declared).
    - job_name: 'kubernetes-pods'

      kubernetes_sd_configs:
      - role: pod

      relabel_configs:
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
        action: replace
        regex: ([^:]+)(?::\d+)?;(\d+)
        replacement: $1:$2
        target_label: __address__
      - action: labelmap
        regex: __meta_kubernetes_pod_label_(.+)
      - source_labels: [__meta_kubernetes_namespace]
        action: replace
        target_label: kubernetes_namespace
      - source_labels: [__meta_kubernetes_pod_name]
        action: replace
        target_label: kubernetes_pod_name

    alerting:
      alertmanagers:
      - scheme: http
        static_configs:
        - targets:
          - "prometheus-alertmanager.monitoring.svc.cluster.local:9093"
